<div style="max-width: 600px; margin: 40px auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); font-family: sans-serif;">
  <h2 style="text-align: center; margin-bottom: 30px;">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #<%= @order.id %></h2>

  <%= form_with model: @order, local: true do |f| %>
    
    <% if @order.errors.any? %>
      <div style="color: red; margin-bottom: 20px;">
        <ul>
          <% @order.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">–î–∞–Ω—ñ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</h3>
    
    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">–Ü–º'—è</label>
      <%= f.text_field :first_name, class: "styled-input", style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
    </div>

    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ü—Ä—ñ–∑–≤–∏—â–µ</label>
      <%= f.text_field :last_name, class: "styled-input", style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
    </div>

    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
      <%= f.text_field :phone, class: "styled-input", style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
    </div>

    <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin: 30px 0 20px;">–î–æ—Å—Ç–∞–≤–∫–∞ (–ù–æ–≤–∞ –ü–æ—à—Ç–∞)</h3>

    <div style="margin-bottom: 15px; position: relative;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ú—ñ—Å—Ç–æ</label>
      <%= f.text_field :city, id: "city-search", class: "styled-input", placeholder: "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞...", autocomplete: "off", style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
      <input type="hidden" id="city-ref">
      <ul id="city-suggestions" class="suggestions-list"></ul>
    </div>

    <div style="margin-bottom: 15px; position: relative;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è / –ü–æ—à—Ç–æ–º–∞—Ç</label>
      <%= f.text_field :address, id: "warehouse-search", class: "styled-input", placeholder: "–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ...", autocomplete: "off", style: "width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" %>
      <ul id="warehouse-suggestions" class="suggestions-list"></ul>
    </div>

    <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin: 30px 0 20px;">üì¶ –°–∫–ª–∞–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>

    <div style="background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
      <%= f.fields_for :order_items do |item_form| %>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
          
          <div style="flex: 2;">
            <strong><%= item_form.object.product.name %></strong>
            <div style="font-size: 12px; color: #777;">–¶—ñ–Ω–∞: <%= item_form.object.price %> ‚Ç¥</div>
          </div>

          <div style="flex: 1; text-align: center;">
            <label style="font-size: 12px; display: block; margin-bottom: 2px;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</label>
            <%= item_form.number_field :quantity, min: 1, style: "width: 60px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px;" %>
          </div>

          <div style="flex: 1; text-align: right;">
            <label style="font-size: 12px; color: #d9534f; cursor: pointer; display: flex; align-items: center; justify-content: flex-end; gap: 5px;">
              <%= item_form.check_box :_destroy %> –í–∏–¥–∞–ª–∏—Ç–∏
            </label>
          </div>
          
        </div>
      <% end %>
      
      <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
        ‚ÑπÔ∏è –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞ –ø–µ—Ä–µ—Ä–∞—Ö—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.
      </p>
    </div>

    <div style="margin-top: 30px; display: flex; gap: 10px;">
      <%= f.submit "–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏", style: "flex: 1; background: black; color: white; padding: 15px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;" %>
      <%= link_to "–°–∫–∞—Å—É–≤–∞—Ç–∏", dashboard_path, style: "padding: 15px 20px; background: #eee; color: #333; text-decoration: none; border-radius: 6px;" %>
    </div>

  <% end %>
</div>

<style>
  .suggestions-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    list-style: none;
    padding: 0;
    margin: 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: none;
  }
  .suggestions-list li {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
  }
  .suggestions-list li:hover {
    background-color: #f8f9fa;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const apiKey = "bd75fb4e41423c9235cb582d02c51084"; // –î–µ–º–æ-–∫–ª—é—á. –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Å–≤—ñ–π, —è–∫—â–æ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏.
  
  const cityInput = document.getElementById('city-search');
  const citySuggestions = document.getElementById('city-suggestions');
  const cityRefInput = document.getElementById('city-ref');
  
  const warehouseInput = document.getElementById('warehouse-search');
  const warehouseSuggestions = document.getElementById('warehouse-suggestions');

  // --- 1. –ü–û–®–£–ö –ú–Ü–°–¢–ê ---
  cityInput.addEventListener('input', function() {
    const query = cityInput.value;
    if (query.length < 2) { 
      citySuggestions.style.display = 'none'; 
      return; 
    }

    // –ó–∞–ø–∏—Ç –¥–æ –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏ (searchSettlements)
    fetch('https://api.novaposhta.ua/v2.0/json/', {
      method: 'POST',
      body: JSON.stringify({
        apiKey: apiKey,
        modelName: "Address",
        calledMethod: "searchSettlements",
        methodProperties: {
          CityName: query,
          Limit: "10",
          Page: "1"
        }
      })
    })
    .then(res => res.json())
    .then(data => {
      citySuggestions.innerHTML = '';
      if (data.success && data.data[0].Addresses.length > 0) {
        citySuggestions.style.display = 'block';
        
        data.data[0].Addresses.forEach(item => {
          const li = document.createElement('li');
          // –§–æ—Ä–º—É—î–º–æ –Ω–∞–∑–≤—É: "–ö–∏—ó–≤ (–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.)"
          li.textContent = `${item.Present}`;
          
          li.onclick = function() {
            cityInput.value = item.MainDescription; // –í—Å—Ç–∞–≤–ª—è—î–º–æ –Ω–∞–∑–≤—É
            cityRefInput.value = item.DeliveryCity; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ REF –º—ñ—Å—Ç–∞ –¥–ª—è –ø–æ—à—É–∫—É –≤—ñ–¥–¥—ñ–ª–µ–Ω—å
            citySuggestions.style.display = 'none';
            
            // –û—á–∏—â–∞—î–º–æ –ø–æ–ª–µ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è, –±–æ –º—ñ—Å—Ç–æ –∑–º—ñ–Ω–∏–ª–æ—Å—å
            warehouseInput.value = '';
            warehouseInput.placeholder = "–¢–µ–ø–µ—Ä –æ–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è...";
            warehouseInput.disabled = false;
            
            // –û–¥—Ä–∞–∑—É –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
            loadWarehouses(item.DeliveryCity, '');
          };
          citySuggestions.appendChild(li);
        });
      } else {
        citySuggestions.style.display = 'none';
      }
    });
  });

  // --- 2. –ü–û–®–£–ö –í–Ü–î–î–Ü–õ–ï–ù–ù–Ø ---
  warehouseInput.addEventListener('focus', function() {
      // –Ø–∫—â–æ –º—ñ—Å—Ç–æ –≤–∂–µ –æ–±—Ä–∞–Ω–µ, –ø–æ–∫–∞–∑—É—î–º–æ —Å–ø–∏—Å–æ–∫ –æ–¥—Ä–∞–∑—É –ø—Ä–∏ –∫–ª—ñ–∫—É
      if (cityRefInput.value) {
          loadWarehouses(cityRefInput.value, warehouseInput.value);
      } else {
          warehouseInput.placeholder = "–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ!";
      }
  });

  warehouseInput.addEventListener('input', function() {
    if (!cityRefInput.value) return; // –ë–µ–∑ –º—ñ—Å—Ç–∞ –Ω–µ —à—É–∫–∞—î–º–æ
    loadWarehouses(cityRefInput.value, warehouseInput.value);
  });

  function loadWarehouses(cityRef, query) {
    fetch('https://api.novaposhta.ua/v2.0/json/', {
      method: 'POST',
      body: JSON.stringify({
        apiKey: apiKey,
        modelName: "Address",
        calledMethod: "getWarehouses",
        methodProperties: {
          CityRef: cityRef,
          FindByString: query, // –§—ñ–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É –∞–±–æ –Ω–∞–∑–≤—ñ –≤—É–ª–∏—Ü—ñ
          Limit: "20",
          Page: "1"
        }
      })
    })
    .then(res => res.json())
    .then(data => {
      warehouseSuggestions.innerHTML = '';
      if (data.success && data.data.length > 0) {
        warehouseSuggestions.style.display = 'block';
        
        data.data.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item.Description; // –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ1: –≤—É–ª. ... "
          
          li.onclick = function() {
            warehouseInput.value = item.Description;
            warehouseSuggestions.style.display = 'none';
          };
          warehouseSuggestions.appendChild(li);
        });
      } else {
        warehouseSuggestions.style.display = 'none';
      }
    });
  }

  // –ó–∞–∫—Ä–∏—Ç—Ç—è —Å–ø–∏—Å–∫—ñ–≤ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º–∏
  document.addEventListener('click', e => {
    if (e.target !== cityInput) citySuggestions.style.display = 'none';
    if (e.target !== warehouseInput) warehouseSuggestions.style.display = 'none';
  });
});
</script>