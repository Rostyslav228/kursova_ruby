<style>
  .catalog-container {
    display: flex;
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
    gap: 40px;
    font-family: sans-serif;
  }

  /* –°–ê–ô–î–ë–ê–† */
  .filters-sidebar {
    width: 250px;
    flex-shrink: 0;
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #eee;
    height: fit-content;
  }
  
  .filter-group { margin-bottom: 20px; }
  .filter-btn {
    width: 100%;
    background: black;
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
    text-transform: uppercase;
    font-weight: bold;
    font-size: 12px;
    border-radius: 4px;
  }
  .active-cat { color: #e74c3c !important; font-weight: bold; }

  /* –°–Ü–¢–ö–ê */
  .products-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 30px;
  }

  .product-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    transition: 0.3s;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  .product-card:hover {
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    transform: translateY(-3px);
  }

  .product-image-container {
    height: 280px;
    width: 100%; 
    background: #fff; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow: hidden; 
    position: relative;
    border-bottom: 1px solid #f5f5f5;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 10px;
    box-sizing: border-box;
  }

  .product-info { padding: 15px; display: flex; flex-direction: column; flex: 1; text-align: left; }

  .product-brand {
    font-size: 11px;
    text-transform: uppercase;
    color: #777;
    letter-spacing: 1px;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .product-title { 
    font-size: 15px; font-weight: 600; margin: 0 0 10px; color: #333; text-decoration: none; 
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 42px;
  }

  .stock-status {
    font-size: 12px;
    color: #28a745;
    margin-bottom: 10px;
  }

  /* –¶—ñ–Ω–∏ */
  .price-block { display: flex; align-items: baseline; gap: 10px; margin-bottom: 15px; }
  .current-price { font-size: 20px; font-weight: bold; color: #000; }
  .old-price { font-size: 14px; color: #999; text-decoration: line-through; }
  .discount-badge { background: #ffebe6; color: #ff3b30; font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 4px; }

  /* –†–æ–∑–º—ñ—Ä–∏ */
  .sizes-block { margin-bottom: 15px; }
  .sizes-list { display: flex; gap: 5px; flex-wrap: wrap; }
  .size-box { border: 1px solid #ddd; padding: 5px 8px; font-size: 11px; border-radius: 4px; color: #333; min-width: 25px; text-align: center; }

  /* –ö–Ω–æ–ø–∫–∏ */
  .actions-row { display: flex; gap: 8px; margin-top: auto; }
  .btn-cart { background: black; color: white; border: none; padding: 12px; cursor: pointer; border-radius: 4px; flex: 2; font-weight: bold; font-size: 14px; text-transform: uppercase; }
  .btn-icon { background: white; border: 1px solid #ccc; color: #555; border-radius: 4px; cursor: pointer; padding: 0 12px; height: 100%; font-size: 18px; display: flex; align-items: center; justify-content: center; flex: 1; }
  .btn-icon:hover { background: #f9f9f9; }
  .btn-icon.liked { border-color: #e74c3c; color: #e74c3c; }

  .admin-actions { position: absolute; top: 10px; right: 10px; background: white; padding: 5px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2; display: flex; flex-direction: column; gap: 5px; }
  
  /* –ó—ñ—Ä–æ—á–∫–∏ */
  .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: #ffc107 !important; }
</style>

<div class="catalog-container">
  
  <aside class="filters-sidebar">
    <h3 style="margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px;">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</h3>
    <div style="margin-bottom: 20px;">
      <%= link_to "–í—Å—ñ —Ç–æ–≤–∞—Ä–∏", products_path, style: "font-weight: bold; color: black; text-decoration: none;" %>
    </div>
    <% if defined?(Category) %>
      <% Category.where(parent_id: nil).each do |main_category| %>
        <div style="margin-bottom: 15px;">
          <div style="font-weight: bold; text-transform: uppercase; font-size: 13px; color: #333; margin-bottom: 5px;">
            <%= link_to main_category.name, products_path(category_id: main_category.id), style: "text-decoration: none; color: inherit;" %>
          </div>
          <div style="display: flex; flex-direction: column; gap: 5px; padding-left: 10px; border-left: 2px solid #f0f0f0;">
            <% main_category.subcategories.each do |sub| %>
              <%= link_to sub.name, products_path(category_id: sub.id), class: (params[:category_id].to_i == sub.id ? "active-cat" : ""), style: "font-size: 13px; color: #666; text-decoration: none; padding: 2px 0;" %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
    
    <h3 style="margin-top: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px;">–§—ñ–ª—å—Ç—Ä —Ü—ñ–Ω</h3>
    <%= form_with url: products_path, method: :get, local: true do |f| %>
      <div class="filter-group">
        <div style="display: flex; gap: 10px;">
          <%= f.number_field :min_price, value: params[:min_price], placeholder: "–í—ñ–¥", style: "width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" %>
          <%= f.number_field :max_price, value: params[:max_price], placeholder: "–î–æ", style: "width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" %>
        </div>
      </div>
      <%= f.submit "–û–ö", class: "filter-btn" %>
      <%= link_to "–°–∫–∏–Ω—É—Ç–∏", products_path, style: "display: block; text-align: center; margin-top: 10px; font-size: 12px; color: #666;" %>
    <% end %>
  </aside>

  <main style="width: 100%;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤</h2>
      <% if current_user&.admin? %>
        <%= link_to "+ –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä", new_product_path, class: "filter-btn", style: "width: auto; background: #28a745; text-decoration: none; padding: 10px 20px;" %>
      <% end %>
    </div>

    <div class="products-grid">
      <% if @products.any? %>
        <% @products.each do |product| %>
          <div class="product-card">
            
            <div class="product-image-container">
              <% if product.images.attached? %>
                <%= image_tag product.images[0], class: "product-image" %>
              <% else %>
                <span style="font-size: 40px; color: #eee;">üì∑</span>
              <% end %>
            </div>
            
            <% if current_user&.admin? %>
              <div class="admin-actions">
                <%= link_to "‚úèÔ∏è", edit_product_path(product), title: "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏", style: "text-decoration: none;" %>
                <%= link_to "üóëÔ∏è", product_path(product), data: { turbo_method: :delete, turbo_confirm: "–í–∏–¥–∞–ª–∏—Ç–∏?" }, style: "text-decoration: none;", title: "–í–∏–¥–∞–ª–∏—Ç–∏" %>
              </div>
            <% end %>

            <div class="product-info">
              
              <div class="product-brand">
                 <%= product.brand.presence || (product.respond_to?(:category) && product.category ? product.category.name : "–ë—Ä–µ–Ω–¥") %>
              </div>

              <%= link_to product.name, product_path(product), class: "product-title" %>
              
              <div class="stock-status">
                 <% if product.quantity.to_i > 0 %>
                   <span>‚úÖ –Ñ –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
                 <% else %>
                   <span style="color: #dc3545;">‚ùå –ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
                 <% end %>
              </div>

              <% if product.sizes.present? %>
                <div class="sizes-block">
                  <div class="sizes-list">
                    <% product.sizes.split(',').each do |size| %>
                      <span class="size-box"><%= size.strip %></span>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <div class="price-block">
                <span class="current-price"><%= number_to_currency(product.price, unit: "‚Ç¥", format: "%n %u", precision: 0) %></span>
                <% if product.old_price.present? && product.old_price > product.price %>
                  <span class="old-price"><%= number_to_currency(product.old_price, unit: "‚Ç¥", format: "%n %u", precision: 0) %></span>
                  <span class="discount-badge">-<%= ((1 - (product.price / product.old_price)) * 100).round %>%</span>
                <% end %>
              </div>
              
              <div class="actions-row">
                <%= button_to cart_items_path(product_id: product.id), class: "btn-cart" do %>
                   –í –∫–æ—à–∏–∫
                <% end %>

                <button type="button" class="btn-icon" onclick="openProductReviewModal('<%= product.id %>', '<%= product.name %>')" title="–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫">
                  üí¨
                </button>

                <% if user_signed_in? %>
                  <% if current_user.favorite_products.include?(product) %>
                    <%= button_to product_favorites_path(product), method: :delete, class: "btn-icon liked", title: "–í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ" do %>‚ù§Ô∏è<% end %>
                  <% else %>
                    <%= button_to product_favorites_path(product), method: :post, class: "btn-icon", title: "–î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ" do %>ü§ç<% end %>
                  <% end %>
                <% end %>
              </div>

            </div>
          </div>
        <% end %>
      <% else %>
        <p style="grid-column: 1 / -1; text-align: center; color: #777;">–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>
      <% end %>
    </div>
  </main>
</div>

<div id="product-review-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; padding: 30px; border-radius: 10px; width: 400px; text-align: center; position: relative;">
    <h3 style="margin-top: 0;">–í—ñ–¥–≥—É–∫ –Ω–∞ —Ç–æ–≤–∞—Ä</h3>
    <p id="modal-product-name" style="color: #777; font-size: 14px; margin-bottom: 20px;"></p>
    
    <%= form_with url: "#", method: :post, id: "product-review-form", local: true do |f| %>
      
      <div class="star-rating" style="display: flex; flex-direction: row-reverse; justify-content: center; gap: 5px; margin: 20px 0;">
        <% 5.downto(1) do |i| %>
          <input type="radio" id="p_star<%= i %>" name="review[rating]" value="<%= i %>" style="display: none;" required>
          <label for="p_star<%= i %>" style="font-size: 30px; color: #ddd; cursor: pointer; transition: 0.2s;">‚òÖ</label>
        <% end %>
      </div>

      <div style="margin-bottom: 20px;">
        <%= f.text_area :"review[comment]", name: "review[comment]", placeholder: "–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à—ñ –≤—Ä–∞–∂–µ–Ω–Ω—è...", style: "width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" %>
      </div>

      <button type="submit" class="filter-btn">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
    <% end %>

    <button onclick="closeProductReviewModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
  </div>
</div>

<script>
  function openProductReviewModal(productId, productName) {
    const modal = document.getElementById('product-review-modal');
    const form = document.getElementById('product-review-form');
    const nameLabel = document.getElementById('modal-product-name');
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —à–ª—è—Ö: /products/:id/reviews
    form.action = "/products/" + productId + "/reviews";
    nameLabel.textContent = productName;
    
    modal.style.display = 'flex';
  }

  function closeProductReviewModal() {
    document.getElementById('product-review-modal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('product-review-modal');
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
</script>